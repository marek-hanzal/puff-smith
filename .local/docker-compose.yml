version: '2'
services:
    app:
        image: marekhanzal/puff-smith:latest
        hostname: puff-smith
        depends_on:
            - mariadb
            - mongo
            - pgbouncer
            - loki
            - mailhog
        environment:
            DATABASE_URL: "postgresql://puff-smith:1234@postgres:5432/puff-smith?schema=public"
            BOUNCER_URL: "postgresql://puff-smith:1234@pgbouncer:6432/puff-smith?schema=public&pgbouncer=true"
            NEXTAUTH_URL: 'http://localhost:42000'
            NEXTAUTH_SECRET: '1234'
            NEXTAUTH_GITHUB_CLIENT_ID: 'abbc01fc85709ab26921'
            NEXTAUTH_GITHUB_CLIENT_SECRET: 'd1d4c98417588b8280c60ee0b3b4233761d529f7'
            AGENDA_DB: root:1234@mongo:27017/?authSource=admin
            EMAIL_SERVER: smtp://mailhog:1025
            EMAIL_FROM: noreply@puff-smith.rocks
            LOKI_URL: "http://loki:3100"
        networks:
            - pgbouncer
            - mongo
            - loki
            - prometheus
        ports:
            - "127.0.0.1:42000:3000"

    mongo:
        image: mongo:5
        environment:
            MONGO_INITDB_ROOT_USERNAME: root
            MONGO_INITDB_ROOT_PASSWORD: 1234
            MONGO_INITDB_DATABASE: agenda
        ports:
            - "127.0.0.1:47017:27017"
        networks:
            - mongo

    postgres:
        image: postgres:14.2
        networks:
            - postgres
            - pgbouncer
        environment:
            POSTGRES_USER: puff-smith
            POSTGRES_DB: puff-smith
            POSTGRES_PASSWORD: 1234

    pgbouncer:
        image: bitnami/pgbouncer
        depends_on:
            - postgres
        environment:
            POSTGRESQL_HOST: postgres
            POSTGRESQL_USERNAME: puff-smith
            POSTGRESQL_PASSWORD: 1234
            POSTGRESQL_DATABASE: puff-smith
            PGBOUNCER_POOL_MODE: transaction
            PGBOUNCER_PORT: 6432
            PGBOUNCER_MIN_POOL_SIZE: 4
            PGBOUNCER_MAX_DB_CONNECTIONS: 12
            PGBOUNCER_IGNORE_STARTUP_PARAMETERS: 'extra_float_digits'
            PGBOUNCER_EXTRA_ARGS: '--verbose'
            PGBOUNCER_DATABASE: puff-smith
        networks:
            - postgres
            - pgbouncer

    loki:
        image: grafana/loki
        networks:
            - loki

    grafana:
        image: grafana/grafana-oss
        ports:
            - "127.0.0.1:42300:3000"
        volumes:
            - ./grafana/provisioning:/etc/grafana/provisioning
        networks:
            - loki
            - prometheus

    prometheus:
        image: prom/prometheus
        command:
            - '--config.file=/etc/prometheus/prometheus.yml'
            - '--storage.tsdb.path=/prometheus'
            - '--web.console.libraries=/usr/share/prometheus/console_libraries'
            - '--web.console.templates=/usr/share/prometheus/consoles'
        networks:
            - prometheus
        ports:
            - "127.0.0.1:45090:9090"
        volumes:
            - ./prometheus:/etc/prometheus

    mailhog:
        image: mailhog/mailhog
        ports:
            - "127.0.0.1:42080:8025"

networks:
    postgres:
    pgbouncer:
    mongo:
    loki:
    prometheus:
    mailhog:
